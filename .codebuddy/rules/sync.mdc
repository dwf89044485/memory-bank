---
description: 同步工具设计决策记录。记录 sync 脚本开发过程中的技术选择、方案对比和问题解决。
alwaysApply: false
---

# 同步工具设计决策记录

> sync 是一个自动化同步工具，用于从远程服务器同步项目文件到本地。它通过 SSH/SCP 协议安全传输文件，支持多目标同步、详细诊断和自动执行。

---

## 已纳入同步范围

| # | 同步内容 | 远程服务器 | 添加时间 |
|---|----------|------------|----------|
| 1 | memory-bank 技能包 | root@memory-bank.devcloud.woa.com:36000 | 2026-01-12 12:30 |
| 2 | 项目规则文件 (brief.mdc, decisions.mdc) | root@memory-bank.devcloud.woa.com:36000 | 2026-01-12 12:30 |

---

## 版本历史

| 版本 | 日期 | 主要变化 |
|------|------|----------|
| 0.1.0 | 2026-01-12 12:30 | 初始设计：基础同步功能、双任务架构 |
| 0.2.0 | 2026-01-12 13:00 | 诊断完善：详细错误分析、日志记录 |
| 0.3.0 | 2026-01-12 13:30 | 交互优化：失败驻留、自动关闭、权限修复 |

---

## 快速索引

| # | 决策 | 核心要点 | 类别 | 版本 |
|---|------|----------|------|------|
| [1](#decision-1) | 传输协议选择 | SCP 而非 rsync | 技术 | 0.1.0 |
| [2](#decision-2) | 文件覆盖策略 | 技能包删除重建，规则文件覆盖 | 策略 | 0.1.0 |
| [3](#decision-3) | 自动关闭方案 | exit 0 + Terminal 偏好设置 | 体验 | 0.3.0 |
| [4](#decision-4) | 权限修复策略 | 传输后自动设置 u+rw | 安全 | 0.3.0 |

---

## 决策详情

### 1. 传输协议选择 ⚡ {#decision-1}

**时间**：2026-01-12 12:35

**问题**：使用 SCP 还是 rsync 进行文件传输？

**方案对比**：

| 方案 | 优点 | 缺点 |
|------|------|------|
| SCP | macOS 原生支持，无需安装 | 每次全量传输，无法增量 |
| rsync | 增量同步，只传输变化文件 | 需要额外安装，Google Drive 冲突 |

**决策**：使用 SCP

**依据**：
1. macOS 原生支持，用户无需额外安装
2. rsync 在 Google Drive 同步场景下容易导致文件锁定
3. 技能包体积小，全量传输可以接受
4. 脚本需要双击即用，依赖越少越好

**测试过程**：
- 初版使用 rsync，在 Google Drive 目录下卡在备份步骤
- 改用 SCP 后，直接删除重建，问题解决

**洞察**：`可用性 > 性能优化，减少依赖比增量同步更重要`

---

### 3. 文件覆盖策略 ⚡ {#decision-3}

**时间**：2026-01-12 12:40

**问题**：如何处理本地已有文件？

**方案对比**：

| 策略 | 适用场景 |
|------|----------|
| 直接删除重建 | 技能包：结构变化大，全量覆盖更可靠 |
| 覆盖单个文件 | 规则文件：独立文件，直接覆盖即可 |
| 创建备份 | 不需要：用户有 Git 历史和远程备份 |

**决策**：差异化策略
- **技能包**：删除整个目录 → 重新下载
- **规则文件**：直接覆盖，不删除目录

**依据**：
- 技能包结构可能变化，全量覆盖更安全
- 规则文件是独立的，直接覆盖即可
- Google Drive 有版本历史，无需本地备份
- 减少操作步骤 = 减少出错机会

**洞察**：`根据文件特性选择覆盖策略，不要一刀切`

---

### 3. 自动关闭方案 ⚡ {#decision-3}

**时间**：2026-01-12 13:30

**问题**：如何让 .command 文件执行完后自动关闭终端？

**尝试方案**：

| 方案 | 结果 |
|------|------|
| `exit 0` | ❌ Terminal 不关闭（默认行为保持窗口） |
| AppleScript 关闭窗口 | ❌ 需要手动包装，操作复杂 |
| 修改 Terminal 偏好设置 | ✅ 一劳永逸 |

**决策**：
1. 脚本中使用 `exit 0` 结束
2. 指导用户在 Terminal 偏好设置中改为"shell 退出时关闭窗口"
3. 失败时驻留，成功后立即退出

**依据**：
1. macOS Terminal 默认保持窗口打开，这是设计行为
2. 偏好设置是系统级别的，一次配置永久生效
3. 脚本内无法强制关闭终端窗口（这是设计限制）

**用户指导**：
```
Terminal → 偏好设置 → 描述文件 → Shell
→ "当 shell 退出时" 改为 "关闭窗口"
```

**洞察**：`了解系统限制，在用户端解决问题比 hack 更可靠`

---

### 4. 权限修复策略 ⚡ {#decision-4}

**时间**：2026-01-12 13:35

**问题**：从远程传输的文件权限可能不符合本地需求

**现象**：
- SCP 传输会保留远程文件权限
- root 用户创建的文件，本地普通用户可能无法编辑
- Claude 技能需要用户有读写权限

**决策**：传输完成后自动修复权限
```bash
chmod -R u+rw "$LOCAL_PATH"
```

**依据**：
1. 确保用户有完全访问权限
2. 只设置用户权限，不影响组和其他人
3. 递归应用到所有子目录和文件

**洞察**：`自动化需要覆盖边界情况，权限问题不能依赖用户手动处理`

---

## 决策演变

| 版本 | 时间 | 原决策 | 调整后 | 原因 |
|------|------|--------|--------|------|
| 0.1.0 | 01-12 12:35 | 使用 rsync | 改用 SCP | Google Drive 冲突，减少依赖 |
| 0.1.0 | 01-12 12:40 | 统一覆盖策略 | 差异化策略（删除/覆盖） | 根据文件特性选择 |
| 0.3.0 | 01-12 13:30 | 尝试脚本内关闭 | 偏好设置 + exit | 系统限制，用户端解决 |

---

## 关键洞察

### 可用性优先
> 可用性 > 性能优化，减少依赖比增量同步更重要。用户双击即用比完美的增量同步更有价值。

### 差异化策略
> 根据文件特性选择覆盖策略。全量重建适合结构变化大的文件，直接覆盖适合独立文件。

### 系统限制
> 了解系统限制，在用户端解决问题比 hack 更可靠。Terminal 不自动关闭是设计行为，应该通过偏好设置解决。

### 权限自动化
> 自动化需要覆盖边界情况。权限问题不能依赖用户手动处理，脚本应该自动修复。

---

*最后更新：2026-01-12 13:45*  
*当前版本：0.3.0*  
*作者：JosephDeng*
